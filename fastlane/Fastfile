# Fastfile for BetterIslam Q&A
# Cordova mobile app CI/CD automation

default_platform(:android)

# ============================================================================
# ANDROID
# ============================================================================

platform :android do

  desc "Build and test Android app"
  lane :build do |options|
    # Build Vite web app first
    sh("cd .. && yarn install --frozen-lockfile")
    sh("cd .. && yarn test:all")
    sh("cd .. && yarn build")

    # Build Cordova Android app
    release_type = options[:release] ? "release" : "debug"

    cordova(
      platform: 'android',
      release: options[:release] || false
    )

    UI.success("‚úÖ Android #{release_type} build completed!")
  end

  desc "Build debug APK for testing"
  lane :debug do
    build(release: false)
  end

  desc "Build release APK and AAB"
  lane :release do
    # Increment version
    sh("cd .. && yarn version:patch")

    build(release: true)

    # Build AAB for Play Store
    cordova(
      platform: 'android',
      release: true,
      type: 'bundle'
    )

    UI.success("‚úÖ Android release builds (APK + AAB) completed!")
  end

  desc "Deploy to Google Play Open Testing track"
  lane :beta do
    # Note: Assumes cordova build already completed in CI/CD workflow
    # The AAB is pre-built and signed, just upload it

    # Use environment variable if set (CI/CD), otherwise use local file (local testing)
    json_key = ENV['PLAY_STORE_JSON_KEY'] || File.expand_path('../google-play-api-key.json')

    upload_to_play_store(
      track: 'beta',
      package_name: 'com.dkurve.betterislamqa',
      aab: 'platforms/android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: json_key
    )

    UI.success("‚úÖ Successfully deployed to Google Play Open Testing!")
  end

  desc "Promote from beta to production track"
  lane :promote_to_production do
    # Use environment variable if set (CI/CD), otherwise use local file (local testing)
    json_key = ENV['PLAY_STORE_JSON_KEY'] || File.expand_path('../google-play-api-key.json')

    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      package_name: 'com.dkurve.betterislamqa',
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: json_key
    )

    UI.success("‚úÖ Promoted to Google Play Production!")
  end

  desc "Deploy to Google Play Production"
  lane :production do
    # Note: Assumes cordova build already completed in CI/CD workflow
    # The AAB is pre-built and signed, just upload it

    # Use environment variable if set (CI/CD), otherwise use local file (local testing)
    json_key = ENV['PLAY_STORE_JSON_KEY'] || File.expand_path('../google-play-api-key.json')

    upload_to_play_store(
      track: 'production',
      package_name: 'com.dkurve.betterislamqa',
      aab: 'platforms/android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: json_key
    )

    UI.success("‚úÖ Successfully deployed to Google Play Production!")
  end

end

# ============================================================================
# iOS
# ============================================================================

platform :ios do

  desc "Build and test iOS app (local)"
  lane :build do |options|
    # Build Vite web app first
    sh("cd .. && yarn install --frozen-lockfile")
    sh("cd .. && yarn test:all")
    sh("cd .. && yarn build")

    # Prepare Cordova (copy web assets to iOS)
    sh("cd .. && cordova prepare ios")

    # Build Cordova iOS app with Xcode
    build_type = options[:release] ? "Release" : "Debug"
    workspace_path = "BetterIslam Q&A.xcworkspace"
    scheme_name = "BetterIslam Q&A"
    team_id = ENV['FASTLANE_TEAM_ID']
    sh("cd ../platforms/ios && xcodebuild -workspace \"#{workspace_path}\" -scheme \"#{scheme_name}\" -configuration #{build_type} -derivedDataPath build -allowProvisioningUpdates DEVELOPMENT_TEAM=#{team_id} SWIFT_VERSION=5.0 CODE_SIGN_STYLE=Automatic CODE_SIGN_IDENTITY='' PROVISIONING_PROFILE='' PROVISIONING_PROFILE_SPECIFIER=''")

    UI.success("‚úÖ iOS #{build_type} build completed!")
  end

  desc "Build debug version for simulator"
  lane :debug do
    build(release: false)
  end

  desc "Build release IPA for TestFlight/App Store"
  lane :build_release do
    # Build release version
    build(release: true)

    # Export IPA using xcodebuild with automatic code signing
    workspace_path = "BetterIslam Q&A.xcworkspace"
    scheme_name = "BetterIslam Q&A"
    team_id = ENV['FASTLANE_TEAM_ID']

    # Create export options plist for automatic signing
    export_opts_path = "ExportOptions.plist"

    # Archive the app
    UI.important("üì¶ Archiving iOS app...")
    sh("cd ../platforms/ios && xcodebuild -workspace \"#{workspace_path}\" -scheme \"#{scheme_name}\" -configuration Release -derivedDataPath build -archivePath build/BetterIslamQA.xcarchive archive -allowProvisioningUpdates DEVELOPMENT_TEAM=#{team_id} SWIFT_VERSION=5.0 CODE_SIGN_STYLE=Automatic CODE_SIGN_IDENTITY='' PROVISIONING_PROFILE='' PROVISIONING_PROFILE_SPECIFIER=''")

    # Export IPA with automatic code signing
    UI.important("üì§ Exporting IPA with automatic code signing...")
    sh("cd ../platforms/ios && xcodebuild -exportArchive -archivePath build/BetterIslamQA.xcarchive -exportPath build -exportOptionsPlist #{export_opts_path} -allowProvisioningUpdates")

    UI.success("‚úÖ iOS release IPA created at platforms/ios/build/BetterIslamQA.ipa!")
  end

  desc "Deploy to TestFlight (local) - requires App Store Connect API Key"
  lane :beta do
    UI.important("üöÄ TestFlight Deployment")
    UI.important("================================================")

    # Increment patch version
    sh("cd .. && yarn version:patch")

    # Build release IPA
    build_release

    # Get API Key from environment or file
    api_key_path = ENV['FASTLANE_API_KEY_PATH'] || File.expand_path('../../.fastlane/api_key.json')

    unless File.exist?(api_key_path)
      UI.error("‚ùå API Key not found at #{api_key_path}")
      UI.important("Please set FASTLANE_API_KEY_PATH or place api_key.json in .fastlane/ directory")
      UI.important("See fastlane/README_IOS_SETUP.md for setup instructions")
      exit 1
    end

    api_key = app_store_connect_api_key(
      key_id: ENV['FASTLANE_API_KEY_ID'],
      issuer_id: ENV['FASTLANE_API_ISSUER_ID'],
      key_filepath: api_key_path,
      duration: 1200 # 20 minutes
    )

    # Upload to TestFlight
    UI.important("üì§ Uploading to TestFlight...")
    upload_to_testflight(
      api_key: api_key,
      ipa: 'platforms/ios/build/BetterIslamQA.ipa',
      skip_waiting_for_build_processing: true,
      skip_submission: false,
      distribute_external: false
    )

    UI.success("‚úÖ Successfully uploaded to TestFlight!")
    UI.success("Visit https://appstoreconnect.apple.com to manage TestFlight builds")
  end

  desc "Deploy to App Store Production (local) - requires App Store Connect API Key"
  lane :production do
    UI.important("üöÄ App Store Production Deployment")
    UI.important("================================================")
    UI.warn("‚ö†Ô∏è  This will submit to App Store for review!")

    # Prompt user for confirmation
    unless UI.confirm("Are you sure you want to submit to App Store? (type 'yes'):")
      UI.error("‚ùå Cancelled")
      exit 1
    end

    # Increment patch version
    sh("cd .. && yarn version:patch")

    # Build release IPA
    build_release

    # Get API Key from environment or file
    api_key_path = ENV['FASTLANE_API_KEY_PATH'] || File.expand_path('../../.fastlane/api_key.json')

    unless File.exist?(api_key_path)
      UI.error("‚ùå API Key not found at #{api_key_path}")
      UI.important("Please set FASTLANE_API_KEY_PATH or place api_key.json in .fastlane/ directory")
      UI.important("See fastlane/README_IOS_SETUP.md for setup instructions")
      exit 1
    end

    api_key = app_store_connect_api_key(
      key_id: ENV['FASTLANE_API_KEY_ID'],
      issuer_id: ENV['FASTLANE_API_ISSUER_ID'],
      key_filepath: api_key_path,
      duration: 1200 # 20 minutes
    )

    # Upload to App Store
    UI.important("üì§ Uploading to App Store...")
    upload_to_app_store(
      api_key: api_key,
      ipa: 'platforms/ios/build/BetterIslamQA.ipa',
      skip_metadata: true,
      skip_screenshots: true,
      force: false,
      submit_for_review: true,
      automatic_release: false # Manually release after review
    )

    UI.success("‚úÖ Successfully submitted to App Store!")
    UI.success("Visit https://appstoreconnect.apple.com to monitor review status")
  end

end

# ============================================================================
# SHARED LANES
# ============================================================================

desc "Run tests"
lane :test do
  sh("cd .. && yarn test:all")
  UI.success("‚úÖ All tests passed!")
end

desc "Increment version (patch)"
lane :bump_version do
  sh("cd .. && yarn version:patch")
  UI.success("‚úÖ Version incremented!")
end

# Error handling
error do |lane, exception|
  UI.error("‚ùå Error in lane #{lane}: #{exception.message}")
end
