# Fastfile for BetterIslam Q&A
# Cordova mobile app CI/CD automation

default_platform(:android)

# ============================================================================
# ANDROID
# ============================================================================

platform :android do

  desc "Build and test Android app"
  lane :build do |options|
    # Build Vite web app first
    sh("cd .. && yarn install --frozen-lockfile")
    sh("cd .. && yarn test:all")
    sh("cd .. && yarn build")

    # Build Cordova Android app
    release_type = options[:release] ? "release" : "debug"

    cordova(
      platform: 'android',
      release: options[:release] || false
    )

    UI.success("‚úÖ Android #{release_type} build completed!")
  end

  desc "Build debug APK for testing"
  lane :debug do
    build(release: false)
  end

  desc "Build release APK and AAB"
  lane :release do
    # Increment version
    sh("cd .. && yarn version:patch")

    build(release: true)

    # Build AAB for Play Store
    cordova(
      platform: 'android',
      release: true,
      type: 'bundle'
    )

    UI.success("‚úÖ Android release builds (APK + AAB) completed!")
  end

  desc "Deploy to Google Play Open Testing track"
  lane :beta do
    # Note: Assumes cordova build already completed in CI/CD workflow
    # The AAB is pre-built and signed, just upload it

    # Use environment variable if set (CI/CD), otherwise use local file (local testing)
    json_key = ENV['PLAY_STORE_JSON_KEY'] || File.expand_path('../google-play-api-key.json')

    upload_to_play_store(
      track: 'beta',
      package_name: 'com.dkurve.betterislamqa',
      aab: 'platforms/android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: json_key
    )

    UI.success("‚úÖ Successfully deployed to Google Play Open Testing!")
  end

  desc "Promote from beta to production track"
  lane :promote_to_production do
    # Use environment variable if set (CI/CD), otherwise use local file (local testing)
    json_key = ENV['PLAY_STORE_JSON_KEY'] || File.expand_path('../google-play-api-key.json')

    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      package_name: 'com.dkurve.betterislamqa',
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: json_key
    )

    UI.success("‚úÖ Promoted to Google Play Production!")
  end

  desc "Deploy to Google Play Production"
  lane :production do
    # Note: Assumes cordova build already completed in CI/CD workflow
    # The AAB is pre-built and signed, just upload it

    # Use environment variable if set (CI/CD), otherwise use local file (local testing)
    json_key = ENV['PLAY_STORE_JSON_KEY'] || File.expand_path('../google-play-api-key.json')

    upload_to_play_store(
      track: 'production',
      package_name: 'com.dkurve.betterislamqa',
      aab: 'platforms/android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: json_key
    )

    UI.success("‚úÖ Successfully deployed to Google Play Production!")
  end

end

# ============================================================================
# iOS
# ============================================================================

platform :ios do

  desc "Build and test iOS app (local)"
  lane :build do |options|
    # Build Vite web app first
    sh("cd .. && yarn install --frozen-lockfile")
    sh("cd .. && yarn test:all")
    sh("cd .. && yarn build")

    # Prepare Cordova (copy web assets to iOS)
    sh("cd .. && cordova prepare ios")

    # Build Cordova iOS app with Xcode
    build_type = options[:release] ? "Release" : "Debug"
    workspace_path = "BetterIslam Q&A.xcworkspace"
    scheme_name = "BetterIslam Q&A"
    sh("cd ../platforms/ios && xcodebuild -workspace \"#{workspace_path}\" -scheme \"#{scheme_name}\" -configuration #{build_type} -derivedDataPath build")

    UI.success("‚úÖ iOS #{build_type} build completed!")
  end

  desc "Build debug version for simulator"
  lane :debug do
    build(release: false)
  end

  desc "Build release IPA for App Store"
  lane :release do
    # Increment version
    sh("cd .. && yarn version:patch")

    # Build release version
    build(release: true)

    # Export IPA using xcodebuild
    workspace_path = "BetterIslam Q&A.xcworkspace"
    scheme_name = "BetterIslam Q&A"
    sh("cd ../platforms/ios && xcodebuild -workspace \"#{workspace_path}\" -scheme \"#{scheme_name}\" -configuration Release -derivedDataPath build -archivePath build/BetterIslamQA.xcarchive archive")
    sh("cd ../platforms/ios/build && xcodebuild -exportArchive -archivePath BetterIslamQA.xcarchive -exportPath . -exportOptionsPlist ../ExportOptions.plist")

    UI.success("‚úÖ iOS release IPA created!")
  end

  desc "Deploy to TestFlight (local)"
  lane :beta do
    UI.important("üîß Deploying to TestFlight requires:")
    UI.important("  - APPLE_ID env var set (Apple ID email)")
    UI.important("  - FASTLANE_PASSWORD env var set (app-specific password)")
    UI.important("")
    UI.important("Set variables and run: fastlane ios beta")

    # Build release version
    release

    # Upload to TestFlight
    upload_to_testflight(
      ipa: 'platforms/ios/build/BetterIslamQA.ipa',
      skip_waiting_for_build_processing: true,
      apple_id: ENV['APPLE_ID'],
      app_identifier: 'com.dkurve.betterislamqa',
      skip_submission: false
    )

    UI.success("‚úÖ Successfully deployed to TestFlight!")
  end

  desc "Deploy to App Store (local)"
  lane :production do
    UI.important("üîß Deploying to App Store requires:")
    UI.important("  - APPLE_ID env var set (Apple ID email)")
    UI.important("  - FASTLANE_PASSWORD env var set (app-specific password)")
    UI.important("")
    UI.important("Set variables and run: fastlane ios production")

    # Build release version
    release

    # Upload to App Store
    upload_to_app_store(
      ipa: 'platforms/ios/build/BetterIslamQA.ipa',
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false,
      force: true
    )

    UI.success("‚úÖ Successfully deployed to App Store!")
  end

end

# ============================================================================
# SHARED LANES
# ============================================================================

desc "Run tests"
lane :test do
  sh("cd .. && yarn test:all")
  UI.success("‚úÖ All tests passed!")
end

desc "Increment version (patch)"
lane :bump_version do
  sh("cd .. && yarn version:patch")
  UI.success("‚úÖ Version incremented!")
end

# Error handling
error do |lane, exception|
  UI.error("‚ùå Error in lane #{lane}: #{exception.message}")
end
